# Spring Cloud Gateway Lab (í•˜ì´ë¸Œë¦¬ë“œ ë¡œê¹… ì‹œìŠ¤í…œ)

ì´ í”„ë¡œì íŠ¸ëŠ” **Spring Cloud Gateway (WebFlux)**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ êµ¬ì¶•ëœ ê³ ì„±ëŠ¥ API ê²Œì´íŠ¸ì›¨ì´ì´ë©°, ëŒ€ê·œëª¨ íŠ¸ë˜í”½ í™˜ê²½ì— ìµœì í™”ëœ **í•˜ì´ë¸Œë¦¬ë“œ ë¡œê¹… ì•„í‚¤í…ì²˜**ë¥¼ êµ¬í˜„í•œ ì˜ˆì œì…ë‹ˆë‹¤.

ëŒ€ìš©ëŸ‰ ìš”ì²­/ì‘ë‹µ ë°”ë””(Body)ë¥¼ ë¡œê¹…í•  ë•Œ ë°œìƒí•˜ëŠ” ë©”ëª¨ë¦¬ ë¶€ì¡±(OOM) ë¬¸ì œì™€ ì„±ëŠ¥ ì €í•˜ë¥¼ ë°©ì§€í•˜ë©´ì„œë„, ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì´ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸ— ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

ì´ ë¡œê¹… ì‹œìŠ¤í…œì€ ì„±ëŠ¥, ë¹„ìš©, ì•ˆì •ì„±ì˜ ê· í˜•ì„ ë§ì¶”ê¸° ìœ„í•´ **"ì´ì›í™” íŒŒì´í”„ë¼ì¸(Dual Pipeline)"** ì „ëµì„ ë”°ë¦…ë‹ˆë‹¤.

### 1. Fast Track (ì‹¤ì‹œê°„ ë©”íƒ€ë°ì´í„°)
*   **ëŒ€ìƒ ë°ì´í„°:** `TxId`, `Path`, `Status`, `Duration`, `ErrorReason`, `BodyUrl` (ì°¸ì¡° ì£¼ì†Œ).
*   **íë¦„:** ê²Œì´íŠ¸ì›¨ì´ -> Kafka Producer -> Kafka í† í”½ (`gateway-meta-logs`).
*   **ëª©ì :** ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ(ELK, Grafana ë“±), ì—ëŸ¬ íŠ¸ë˜í‚¹, íŠ¸ë˜í”½ ë¶„ì„.

### 2. Slow Track (ëŒ€ìš©ëŸ‰ ë°”ë”” ì €ì¥)
*   **ëŒ€ìƒ ë°ì´í„°:** ìš”ì²­/ì‘ë‹µ ë³¸ë¬¸ ì „ì²´ (ìµœëŒ€ 10MB ì´ìƒ ì§€ì›).
*   **íë¦„:**
    1.  ê²Œì´íŠ¸ì›¨ì´ì—ì„œ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  -> **ë¡œì»¬ ì„ì‹œ íŒŒì¼**ì— ì¦‰ì‹œ ê¸°ë¡ (ë¹„ë™ê¸° I/O).
    2.  ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ -> **MinIO (S3 í˜¸í™˜)** ìŠ¤í† ë¦¬ì§€ë¡œ ë¹„ë™ê¸° ì—…ë¡œë“œ.
    3.  ì—…ë¡œë“œ ì™„ë£Œ -> ë¡œì»¬ íŒŒì¼ ì‚­ì œ.
*   **ëª©ì :** ìƒì„¸ ê°ì‚¬ ë¡œê·¸(Audit Log), ì¥ì•  ë¶„ì„ìš© ì¦ê±° ë°ì´í„°.
*   **ì¥ì :**
    *   **ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±:** ë°”ë”” ë°ì´í„°ë¥¼ í™ ë©”ëª¨ë¦¬ì— ì ì¬í•˜ì§€ ì•Šê³  ë””ìŠ¤í¬ë¡œ ìŠ¤íŠ¸ë¦¬ë°í•˜ì—¬ OOM ë°©ì§€.
    *   **ì„œë¹„ìŠ¤ ë…ë¦½ì„±:** ì—…ë¡œë“œ ì‹¤íŒ¨ê°€ API ì‘ë‹µ ì†ë„ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ (Fire-and-Forget).
    *   **ë¹„ìš© ìµœì í™”:** ë¹„ì‹¼ DB ì¸ë±ìŠ¤ ì €ì¥ì†Œ ëŒ€ì‹  ì €ë ´í•œ ì˜¤ë¸Œì íŠ¸ ìŠ¤í† ë¦¬ì§€ë¥¼ í™œìš©.

## ğŸš€ ì£¼ìš” íŠ¹ì§•

*   **Spring Boot 3.x & WebFlux:** ì „ì²´ ìŠ¤íƒì´ ë¹„ë™ê¸°/ë…¼ë¸”ë¡œí‚¹(Non-blocking)ìœ¼ë¡œ ë™ì‘.
*   **ìŠ¤í† ë¦¬ì§€ ì¶”ìƒí™”:** ì„¤ì •(`gateway.logs.storage.type`) ë³€ê²½ë§Œìœ¼ë¡œ **MinIO**ì™€ **AWS S3** ê°„ì˜ ì „í™˜ì´ ììœ ë¡œì›€.
*   **ë©”ì‹œì§€ í ì¶”ìƒí™”:** Kafka ì™¸ì— ë‹¤ë¥¸ ë©”ì‹œì§€ íë¡œë„ ì‰½ê²Œ í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°.
*   **ì‹œìŠ¤í…œ íšŒë³µë ¥:**
    *   ê²Œì´íŠ¸ì›¨ì´ëŠ” **ë°ì´í„°ë² ì´ìŠ¤(DB) ì˜ì¡´ì„±ì´ ì „í˜€ ì—†ìŒ**.
    *   Kafkaë‚˜ MinIO ì¥ì•  ì‹œì—ë„ API ì„œë¹„ìŠ¤ëŠ” ì¤‘ë‹¨ ì—†ì´ ì •ìƒ ì‘ë™.

## ğŸ›  ì£¼ìš” ì„¤ì • ê°€ì´ë“œ

`src/main/resources/application.yml` ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ë¥¼ í†µí•´ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### íƒ€ê²Ÿ ì„œë²„ ë° ë¼ìš°íŒ… ì„¤ì • (Target Servers & Routes)
| ì„¤ì • í•­ëª© | í™˜ê²½ë³€ìˆ˜ëª… | ê¸°ë³¸ê°’ | ì„¤ëª… |
| :--- | :--- | :--- | :--- |
| `gateway.routes.server-a.id` | `SERVER_A_ROUTE_ID` | `server_a_route` | ì„œë²„ A ë¼ìš°íŠ¸ ID |
| `gateway.routes.server-a.path` | `SERVER_A_PATH` | `/server-a/**` | ì„œë²„ A ë¼ìš°íŒ… ê²½ë¡œ íŒ¨í„´ |
| `gateway.routes.server-a.uri` | `SERVER_A_URL` | `http://localhost:8081` | ì„œë²„ A íƒ€ê²Ÿ URI |
| `gateway.routes.server-b.id` | `SERVER_B_ROUTE_ID` | `server_b_route` | ì„œë²„ B ë¼ìš°íŠ¸ ID |
| `gateway.routes.server-b.path` | `SERVER_B_PATH` | `/server-b/**` | ì„œë²„ B ë¼ìš°íŒ… ê²½ë¡œ íŒ¨í„´ |
| `gateway.routes.server-b.uri` | `SERVER_B_URL` | `http://localhost:8082` | ì„œë²„ B íƒ€ê²Ÿ URI |

### Kafka (ë©”íƒ€ë°ì´í„°)
| ì„¤ì • í•­ëª© | í™˜ê²½ë³€ìˆ˜ëª… | ê¸°ë³¸ê°’ | ì„¤ëª… |
| :--- | :--- | :--- | :--- |
| `gateway.kafka.bootstrap-servers` | `KAFKA_SERVERS` | `localhost:9092` | Kafka ë¸Œë¡œì»¤ ì£¼ì†Œ |
| `gateway.kafka.topic.metadata` | - | `gateway-meta-logs` | ë©”íƒ€ë°ì´í„° ë¡œê·¸ í† í”½ëª… |

### MinIO / S3 (ë°”ë”” ì €ì¥ì†Œ)
| ì„¤ì • í•­ëª© | í™˜ê²½ë³€ìˆ˜ëª… | ê¸°ë³¸ê°’ | ì„¤ëª… |
| :--- | :--- | :--- | :--- |
| `gateway.logs.storage.type` | - | `minio` | `minio` ë˜ëŠ” `s3` |
| `gateway.logs.storage.bucket` | `LOG_BUCKET` | `gateway-logs` | ë²„í‚· ëª…ì¹­ |
| `gateway.logs.minio.endpoint` | `MINIO_ENDPOINT` | `http://localhost:9000` | MinIO ì£¼ì†Œ |
| `gateway.logs.minio.access-key` | `MINIO_ACCESS_KEY` | `minioadmin` | ì•¡ì„¸ìŠ¤ í‚¤ |
| `gateway.logs.minio.secret-key` | `MINIO_SECRET_KEY` | `minioadmin` | ë¹„ë°€ í‚¤ |

## ğŸ“¦ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
src/main/java/org/example/springcloudgatwaylab/
â”œâ”€â”€ config/             # ë¼ìš°íŠ¸ ë° ì•± ì„¤ì •
â”‚   â””â”€â”€ GatewayConfiguration.java
â”œâ”€â”€ filter/             # ì „ì—­ í•„í„°
â”‚   â””â”€â”€ LoggingGlobalFilter.java  (í•µì‹¬ ë¡œì§)
â””â”€â”€ service/            # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë° ì¶”ìƒí™”
    â”œâ”€â”€ LogStorageService.java    (ì¸í„°í˜ì´ìŠ¤)
    â”œâ”€â”€ MinioStorageService.java  (MinIO êµ¬í˜„ì²´)
    â””â”€â”€ KafkaMetadataSender.java  (Kafka ì „ì†¡)
```

## ğŸƒâ€â™‚ï¸ ì‹¤í–‰ ë°©ë²•

1.  **ì¸í”„ë¼ ì¤€ë¹„ (Kafka & MinIO):**
    Docker Compose ë“±ì„ í†µí•´ Kafkaì™€ MinIOë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

2.  **í”„ë¡œì íŠ¸ ë¹Œë“œ ë° ì‹¤í–‰:**
    ```bash
    ./gradlew bootRun
    ```

3.  **í…ŒìŠ¤íŠ¸:**
    ê²Œì´íŠ¸ì›¨ì´ ì£¼ì†Œë¡œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤ (ì˜ˆ: `http://localhost:8080/server-a/hello`).
    *   **ë©”íƒ€ë°ì´í„° í™•ì¸:** Kafka í† í”½ `gateway-meta-logs`ë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.
    *   **ë°”ë”” ë°ì´í„° í™•ì¸:** MinIO ë²„í‚· `gateway-logs`ì— ì €ì¥ëœ íŒŒì¼ì„ í™•ì¸í•©ë‹ˆë‹¤.